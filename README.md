# ASTInterface

This package provides an interface between the adaptive stress testing MDP framework and standard RL-based solvers. This is a modified formulation of AST suited for global adversarial policy determination, where the distance metric is replaced by a Markovian, potential-based reward shaping heuristic. To use `ASTInterface.jl`, create a simulation that inherits from `ASTInterface.Simulation` and implements the functions in `interface.jl`.

The simulation should expose an `Environment` object containing the distributions of the environment variables over which the stress testing takes place. For example,
```
env = ASTInterface.Environment(
    :var1 => Normal(0.0, 1.0),                # scalar variable
    :var2 => Normal([0.0, 1.0], [0.5, 0.1]),  # vector variable
    :var3 => CustomDist(5, 7, 3.0)            # custom distribution
)
```
At each step, the simulation must accept an `EnvironmentValue` object, corresponding to samples from the `Environment`. For example,
```
val = ASTInterface.EnvironmentValue(
    :var1 => 0.657,                      # scalar variable
    :var2 => [0.233, 0.849],             # vector variable
    :var3 => CustomObj(0.121, -3.260)    # custom object
)
```
Note that `EnvironmentValue` objects are never constructed by the user as above, but generated by the interface.

Each environment variable type must implement `Base.rand`, `Distributions.logpdf`, `ASTInterface.flatten`, and `ASTInterface.unflatten`. For example, `var1` requires only
```
ASTInterface.flatten(dist::Normal, val::Float64) = [val / dist.σ]           # quasi-normalized
ASTInterface.unflatten(dist::Normal, arr::Vector{<:Real}) = arr[] * dist.σ  # reconstructed
```
while `var3` requires
```
struct CustomDist <: Sampleable{Multivariate, Continuous}
  a::Beta
  b::Normal
end

CustomDist(alpha, beta, sigma) = CustomDist(Beta(alpha, beta), Normal(0.0, sigma))

struct CustomObj
  x::Float64
  y::Float64
end

Base.rand(dist::CustomDist) = CustomObj(rand(dist.a), rand(dist.b))
Distributions.logpdf(dist::CustomDist, val::CustomObj) = logpdf(dist.a, val.x) + logpdf(dist.b, val.y)

ASTInterface.flatten(dist::CustomDist, val::CustomObj) = [val.x, val.y / dist.b.σ]
ASTInterface.unflatten(dist::CustomDist, arr::Vector{<:Real}) = CustomObj(arr[1], arr[2] * dist.b.σ)
```

For background on original AST formulation, see
> Lee, Ritchie, Mykel J. Kochenderfer, Ole J. Mengshoel, Guillaume P. Brat, and Michael P. Owen. "Adaptive stress testing of airborne collision avoidance systems." In 2015 IEEE/AIAA 34th Digital Avionics Systems Conference (DASC), pp. 6C2-1. IEEE, 2015.
